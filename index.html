<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–ì—Ä–∞ ‚Äî –ø–æ—Ä—è–¥–æ–∫ —Å–ª—ñ–≤</title>
  <style>
    :root{
      --bg:#f4f5f7;
      --card:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --line:#e5e7eb;
      --blue:#0a5fa5;
      --blue2:#084c86;
      --goodBg:#dcfce7;
      --goodTx:#14532d;
      --badBg:#fee2e2;
      --badTx:#7f1d1d;
      --shadow:0 10px 30px rgba(0,0,0,.08);
      --radius:14px;
    }
    *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    body{margin:0;background:var(--bg);color:var(--text)}

    .topbar{
      height:46px;background:#2f2f2f;color:#fff;
      display:flex;justify-content:space-between;align-items:center;
      padding:0 14px;font-size:14px
    }
    .content{max-width:900px;margin:0 auto;padding:16px}
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:18px;
    }
    .center{display:flex;flex-direction:column;align-items:center;gap:14px}
    .titleline{width:100%;border-top:4px solid var(--blue);margin:8px 0 0}
    .prompt{font-size:20px;font-weight:800;text-align:center;margin-top:6px}
    .sub{color:var(--muted);margin:0 0 16px;text-align:center}

    .form{
      width:min(520px, 100%);
      display:grid;gap:12px;margin-top:10px
    }
    label{font-size:13px;color:var(--muted)}
    input{
      width:100%;
      padding:12px 12px;
      border:1px solid var(--line);
      border-radius:12px;
      outline:none;
      font-size:15px;
      background:#fff;
    }
    input:focus{border-color:#b7d4ef; box-shadow:0 0 0 4px rgba(10,95,165,.12)}

    .btn{
      border:none;cursor:pointer;
      padding:12px 16px;border-radius:12px;
      background:var(--blue);color:#fff;font-weight:800;
      font-size:15px;letter-spacing:.2px;
      transition:transform .03s ease, background .15s ease;
      display:inline-flex;align-items:center;justify-content:center;
      min-width:160px;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }
    .btn:hover{background:var(--blue2)}
    .btn:active{transform:translateY(1px)}
    .btn.secondary{background:#111827}
    .btn.secondary:hover{background:#0b1220}

    .row{display:flex;gap:12px;flex-wrap:wrap;justify-content:center}
    .pill{
      font-size:13px;color:#0b1220;background:#eef6ff;border:1px solid #d7e9ff;
      padding:8px 10px;border-radius:999px
    }

    .countdown{font-size:46px;font-weight:900;line-height:1;margin:6px 0 0}

    .listWrap{width:min(560px, 100%); margin-top:6px}
    .list{
      list-style:none;padding:0;margin:0;
      border:1px solid var(--line);
      border-radius:12px; overflow:hidden;
      background:#fff;
    }

    /* –ë—ñ–ª—å—à–µ/–∑—Ä—É—á–Ω—ñ—à–µ –¥–ª—è —Ç–µ–ª–µ—Ñ–æ–Ω—É */
    .item{
      padding:18px 14px;         /* ‚¨Ö bigger hit area */
      border-top:1px solid var(--line);
      display:flex;align-items:center;justify-content:center;
      font-weight:900;
      user-select:none;
      -webkit-user-select:none;
      touch-action:none;         /* ‚¨Ö –≤–∞–∂–ª–∏–≤–æ –¥–ª—è drag –Ω–∞ –º–æ–± */
      background:#fff;
      position:relative;
      font-size:18px;
    }
    .item:first-child{border-top:none}

    /* –ü—ñ–¥—Å–≤—ñ—Ç–∫–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—ñ */
    .item.good{background:var(--goodBg); color:var(--goodTx)}
    .item.bad{background:var(--badBg); color:var(--badTx)}

    /* Drag visuals */
    .item[aria-grabbed="true"]{
      box-shadow:0 10px 22px rgba(0,0,0,.16);
      border:1px solid #cfe6ff;
      z-index:50;
    }

    .hint{font-size:13px;color:var(--muted);text-align:center;margin-top:6px}

    .status{
      margin-top:10px;
      font-size:14px;
      font-weight:800;
      padding:10px 12px;border-radius:12px;
      border:1px solid var(--line);
      background:#fafafa;
      width:min(560px, 100%);
      text-align:center;
    }
    .status.good{border-color:#bbf7d0;background:#f0fdf4;color:#14532d}
    .status.bad{border-color:#fecaca;background:#fef2f2;color:#7f1d1d}

    .summary{width:min(620px,100%);display:grid;gap:8px}
    .kv{
      display:flex;justify-content:space-between;gap:12px;
      padding:10px 12px;border:1px solid var(--line);
      border-radius:12px;background:#fff
    }
    .kv b{font-weight:900}
    .divider{height:1px;background:var(--line);width:100%;margin:8px 0}
    .footerNote{color:var(--muted);font-size:12px;text-align:center;margin-top:6px}
  </style>
</head>

<body>
  <div class="topbar">
    <div id="scoreTop">–ë–∞–ª–∏: 0</div>
    <div id="lvlTop">–†—ñ–≤–µ–Ω—å: 0 / 5</div>
  </div>

  <div class="content">
    <div class="card">
      <div style="font-weight:900;font-size:18px">–ü–æ—Ä—è–¥–æ–∫ —Å–ª—ñ–≤</div>
      <div class="titleline"></div>

      <!-- START -->
      <div id="screenStart" class="center" style="margin-top:14px">
        <div class="prompt">–í–≤–µ–¥—ñ—Ç—å –¥–∞–Ω—ñ –¥–ª—è —Å—Ç–∞—Ä—Ç—É</div>
        <p class="sub">5 —Ä—ñ–≤–Ω—ñ–≤: 3 ‚Üí 7 —Å–ª—ñ–≤. –ß–∞—Å –ø—Ä–æ—Ö–æ–¥–∂–µ–Ω–Ω—è –Ω–µ –æ–±–º–µ–∂–µ–Ω–∏–π.</p>

        <div class="form">
          <div>
            <label for="name">–Ü–º‚Äô—è</label>
            <input id="name" type="text" placeholder="–ù–∞–ø—Ä–∏–∫–ª–∞–¥: –ê–Ω–∞—Å—Ç–∞—Å—ñ—è" autocomplete="name" />
          </div>
          <div>
            <label for="email">–ü–æ—à—Ç–∞</label>
            <input id="email" type="email" placeholder="name@example.com" autocomplete="email" />
          </div>

          <!-- –í–ê–ñ–õ–ò–í–û: type="button" -->
          <button id="btnStart" class="btn" type="button">–ü–æ—á–∞—Ç–∏ –≥—Ä—É</button>

          <div style="font-size:12px;color:#6b7280;text-align:center">
            –ë–µ–∑ –∑–∞–π–≤–æ–≥–æ ‚Äî —Ç—ñ–ª—å–∫–∏ —Å—Ç–∞—Ä—Ç.
          </div>
        </div>
      </div>

      <!-- GAME -->
      <div id="screenGame" class="center" style="display:none; margin-top:14px">
        <div class="prompt" id="phaseTitle">–ó–∞–ø–∞–º‚Äô—è—Ç–∞–π—Ç–µ –ø–æ—Ä—è–¥–æ–∫ —Å–ª—ñ–≤</div>

        <div class="row">
          <div class="pill" id="pillLevel">–†—ñ–≤–µ–Ω—å 1 / 5</div>
          <div class="pill" id="pillWords">–°–ª—ñ–≤: 3</div>
        </div>

        <div id="countdownBox" class="center" style="gap:6px">
          <div class="countdown" id="countdown">8</div>
          <div class="hint">–°–ª–æ–≤–∞ –∑–Ω–∏–∫–Ω—É—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ</div>
        </div>

        <div class="listWrap">
          <ul id="wordList" class="list" aria-label="–°–ø–∏—Å–æ–∫ —Å–ª—ñ–≤"></ul>
          <div class="hint" id="hint">–ü—ñ–¥ —á–∞—Å –∑–∞–ø–∞–º‚Äô—è—Ç–æ–≤—É–≤–∞–Ω–Ω—è –ø–µ—Ä–µ—Ç—è–≥—É–≤–∞–Ω–Ω—è –≤–∏–º–∫–Ω–µ–Ω–µ.</div>
        </div>

        <div class="row" style="margin-top:10px">
          <button id="btnCheck" class="btn" type="button" style="display:none">–ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏</button>
        </div>

        <div id="status" class="status" style="display:none"></div>
      </div>

      <!-- END -->
      <div id="screenEnd" class="center" style="display:none; margin-top:14px">
        <div class="prompt">–†–µ–∑—É–ª—å—Ç–∞—Ç</div>
        <p class="sub" id="endSub">–ì–æ—Ç–æ–≤–æ!</p>

        <div class="summary" id="summary"></div>

        <div class="row" style="margin-top:8px">
          <button id="btnRestart" class="btn secondary" type="button">–ü–æ—á–∞—Ç–∏ –∑–Ω–æ–≤—É</button>
        </div>

        <div class="footerNote">–î—è–∫—É—î–º–æ –∑–∞ –≥—Ä—É üíôüíõ</div>
      </div>
    </div>
  </div>

<script>
/* =======================
   TELEGRAM
   ======================= */
const BOT_TOKEN = "8517397402:AAERo7gAWPoCyCKpx9_T6b4tZRQazAZrX1k";
const CHAT_ID   = "1350269784";

/* =======================
   GAME SETTINGS
   ======================= */
const LEVEL_SIZES = [3,4,5,6,7];
const MEM_SECONDS = 8; // –ø–æ–∫–∞–∑ –Ω–∞ –∑–∞–ø–∞–º'—è—Ç–æ–≤—É–≤–∞–Ω–Ω—è

const WORD_POOL = [
  "–∫–∞–ª–∏–Ω–∞","—Å–≤—ñ—Ç–ª–æ","–≤–µ—Å–Ω–∞","–º—Ä—ñ—è","–≤—ñ—Ç—Ä–∏–ª–∞","–¥–∑–≤—ñ–Ω","–Ω–µ–±–æ","—Ä—ñ–∫–∞","–ª—ñ—Å","—Ö–≤–∏–ª—è",
  "–∑—ñ—Ä–∫–∞","–ø—ñ—Å–Ω—è","–∫—Ä–∏–ª–∞","–ø–∞–º‚Äô—è—Ç—å","—Å–æ–Ω—è—Ö","–≤–∏—à–Ω—è","—Å—Ç–µ–∂–∫–∞","—Ç–µ–ø–ª–æ","—Å–º—ñ—Ö",
  "–¥—Ä—É–∂–±–∞","—Å–∏–ª–∞","–Ω–∞–¥—ñ—è","–≤–æ–≥–Ω–∏–∫","—Å–µ—Ä—Ü–µ","—Ä–∞–Ω–æ–∫","–≤–µ—á—ñ—Ä","–∫–≤—ñ—Ç–∫–∞","–∫—Ä–∏–Ω–∏—Ü—è",
  "–¥–æ—Ä–æ–≥–∞","—Å—Ç—Ä—É–º–æ–∫","—à–∫–æ–ª–∞","–∫–Ω–∏–≥–∞","–æ–ª—ñ–≤–µ—Ü—å","–º—ñ—Å—Ç–æ","—Å–∞–¥–æ–∫","–±–µ—Ä–µ–≥","–≤–∏—à–∏–≤–∞–Ω–∫–∞",
  "–º–∞–Ω–¥—Ä—ñ–≤–∫–∞","–≤–µ—Å–µ–ª–∫–∞","—Ç–∏—à–∞","–ø–æ–≥–ª—è–¥","—Å–ø–æ–∫—ñ–π","–∫–æ–º–∞–Ω–¥–∞","—É—Å–ø—ñ—Ö","–ø—ñ–¥–∫–∞–∑–∫–∞","–ø–∞–∑–ª"
];

/* =======================
   DOM
   ======================= */
const el = (id)=>document.getElementById(id);

const screenStart = el("screenStart");
const screenGame  = el("screenGame");
const screenEnd   = el("screenEnd");

const scoreTop = el("scoreTop");
const lvlTop   = el("lvlTop");

const phaseTitle = el("phaseTitle");
const pillLevel  = el("pillLevel");
const pillWords  = el("pillWords");

const countdownBox = el("countdownBox");
const countdownEl  = el("countdown");
const wordListEl   = el("wordList");
const hintEl       = el("hint");
const btnCheck     = el("btnCheck");
const statusEl     = el("status");

const nameEl  = el("name");
const emailEl = el("email");
const btnStart = el("btnStart");

const summaryEl = el("summary");
const endSubEl  = el("endSub");
const btnRestart = el("btnRestart");

/* =======================
   STATE
   ======================= */
let player = { name:"", email:"" };
let startTimeMs = 0;

let levelIndex = 0;
let score = 0;

let correctOrder = [];
let countdownTimer = null;
let countdownLeft = MEM_SECONDS;

let perLevel = [];

function nowMs(){ return Date.now(); }
function pad(n){ return String(n).padStart(2,"0"); }
function formatTime(ms){
  const s = Math.floor(ms/1000);
  const hh = Math.floor(s/3600);
  const mm = Math.floor((s%3600)/60);
  const ss = s%60;
  return (hh>0 ? `${hh}:${pad(mm)}:${pad(ss)}` : `${mm}:${pad(ss)}`);
}

function setTop(){
  scoreTop.textContent = `–ë–∞–ª–∏: ${score}`;
  lvlTop.textContent = `–†—ñ–≤–µ–Ω—å: ${Math.min(levelIndex+1,5)} / 5`;
}

function showScreen(which){
  screenStart.style.display = which==="start" ? "flex" : "none";
  screenGame.style.display  = which==="game"  ? "flex" : "none";
  screenEnd.style.display   = which==="end"   ? "flex" : "none";
}

function shuffleArray(arr){
  const a = arr.slice();
  for(let i=a.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}

function pickWords(count, avoidSet){
  const pool = WORD_POOL.filter(w => !avoidSet.has(w));
  const src = (pool.length >= count) ? pool : WORD_POOL.slice();
  const mixed = shuffleArray(src);
  return mixed.slice(0, count);
}

function renderList(words){
  wordListEl.innerHTML = "";
  for(const w of words){
    const li = document.createElement("li");
    li.className = "item";
    li.textContent = w.toUpperCase();
    wordListEl.appendChild(li);
  }
}

function enableDrag(enable){
  for(const it of wordListEl.querySelectorAll(".item")){
    it.style.pointerEvents = enable ? "auto" : "none";
  }
}

/* =======================
   DRAG (–∑—Ä—É—á–Ω–∏–π –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω—ñ)
   pointer + placeholder
   ======================= */
let drag = {
  active:false,
  item:null,
  placeholder:null,
  offsetY:0
};

function createPlaceholder(height){
  const ph = document.createElement("li");
  ph.className = "item";
  ph.style.opacity = "0";
  ph.style.height = height + "px";
  ph.textContent = " ";
  return ph;
}

function onPointerDown(e){
  const target = e.target.closest(".item");
  if(!target) return;
  if(btnCheck.style.display === "none") return; // drag —Ç—ñ–ª—å–∫–∏ —É —Ñ–∞–∑—ñ —Å–æ—Ä—Ç—É–≤–∞–Ω–Ω—è

  e.preventDefault();

  drag.active = true;
  drag.item = target;

  const r = target.getBoundingClientRect();
  drag.offsetY = e.clientY - r.top;

  target.setAttribute("aria-grabbed","true");

  // placeholder
  drag.placeholder = createPlaceholder(r.height);
  wordListEl.insertBefore(drag.placeholder, target.nextSibling);

  // move target to body fixed
  wordListEl.removeChild(target);
  document.body.appendChild(target);

  target.style.position = "fixed";
  target.style.left = r.left + "px";
  target.style.top  = r.top + "px";
  target.style.width = r.width + "px";
  target.style.zIndex = "9999";

  document.addEventListener("pointermove", onPointerMove, {passive:false});
  document.addEventListener("pointerup", onPointerUp, {passive:false, once:true});
}

function onPointerMove(e){
  if(!drag.active) return;
  e.preventDefault();

  const item = drag.item;
  const y = e.clientY - drag.offsetY;

  item.style.top = y + "px";

  const items = Array.from(wordListEl.querySelectorAll(".item"));
  const ph = drag.placeholder;

  let insertBefore = null;
  for(const it of items){
    if(it === ph) continue;
    const rect = it.getBoundingClientRect();
    const mid = rect.top + rect.height/2;
    if(e.clientY < mid){
      insertBefore = it;
      break;
    }
  }
  if(insertBefore){
    wordListEl.insertBefore(ph, insertBefore);
  }else{
    wordListEl.appendChild(ph);
  }
}

function onPointerUp(){
  document.removeEventListener("pointermove", onPointerMove);
  if(!drag.active) return;

  const item = drag.item;
  const ph = drag.placeholder;

  drag.active = false;

  item.removeAttribute("aria-grabbed");
  item.style.position = "relative";
  item.style.left = "0px";
  item.style.top = "0px";
  item.style.width = "auto";
  item.style.zIndex = "";

  document.body.removeChild(item);
  wordListEl.insertBefore(item, ph);
  wordListEl.removeChild(ph);

  drag.item = null;
  drag.placeholder = null;
}

wordListEl.addEventListener("pointerdown", onPointerDown, {passive:false});

/* =======================
   GAME FLOW
   ======================= */
function startLevel(){
  setTop();

  const size = LEVEL_SIZES[levelIndex];
  pillLevel.textContent = `–†—ñ–≤–µ–Ω—å ${levelIndex+1} / 5`;
  pillWords.textContent = `–°–ª—ñ–≤: ${size}`;

  // reset UI
  statusEl.style.display = "none";
  statusEl.className = "status";
  btnCheck.style.display = "none";
  countdownBox.style.display = "flex";

  phaseTitle.textContent = "–ó–∞–ø–∞–º‚Äô—è—Ç–∞–π—Ç–µ –ø–æ—Ä—è–¥–æ–∫ —Å–ª—ñ–≤";
  hintEl.textContent = "–ü—ñ–¥ —á–∞—Å –∑–∞–ø–∞–º‚Äô—è—Ç–æ–≤—É–≤–∞–Ω–Ω—è –ø–µ—Ä–µ—Ç—è–≥—É–≤–∞–Ω–Ω—è –≤–∏–º–∫–Ω–µ–Ω–µ.";

  // choose words (–Ω–∞–º–∞–≥–∞—Ç–∏—Å—è –Ω–µ –ø–æ–≤—Ç–æ—Ä—é–≤–∞—Ç–∏)
  const used = new Set(perLevel.flatMap(x => x.words || []));
  correctOrder = pickWords(size, used);

  renderList(correctOrder);
  enableDrag(false);

  // countdown
  clearInterval(countdownTimer);
  countdownLeft = MEM_SECONDS;
  countdownEl.textContent = countdownLeft;
  countdownTimer = setInterval(()=>{
    countdownLeft--;
    countdownEl.textContent = countdownLeft;
    if(countdownLeft<=0){
      clearInterval(countdownTimer);
      beginSortingPhase();
    }
  }, 1000);
}

function beginSortingPhase(){
  phaseTitle.textContent = "–í—ñ–¥–Ω–æ–≤—ñ—Ç—å –ø–æ—Ä—è–¥–æ–∫ —Å–ª—ñ–≤";
  hintEl.textContent = "–ü–µ—Ä–µ—Ç—è–≥–Ω—ñ—Ç—å —Å–ª–æ–≤–∞ —É –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º—É –ø–æ—Ä—è–¥–∫—É —Ç–∞ –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å ¬´–ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏¬ª.";

  countdownBox.style.display = "none";
  btnCheck.style.display = "inline-flex";

  let shuffled = shuffleArray(correctOrder);
  let guard = 0;
  while(shuffled.join("|") === correctOrder.join("|") && guard < 8){
    shuffled = shuffleArray(correctOrder);
    guard++;
  }

  renderList(shuffled);
  enableDrag(true);
}

function getCurrentOrder(){
  return Array.from(wordListEl.children).map(li => li.textContent.toLowerCase());
}

function checkLevel(){
  btnCheck.style.display = "none";
  enableDrag(false);

  const order = getCurrentOrder();
  const items = Array.from(wordListEl.children);

  // –ø—ñ–¥—Å–≤—ñ—Ç–∫–∞ –∫–æ–∂–Ω–æ–≥–æ —Å–ª–æ–≤–∞ (–ø–æ–∑–∏—Ü—ñ–π–Ω–æ)
  let correctPositions = 0;
  for(let i=0;i<correctOrder.length;i++){
    const ok = (order[i] === correctOrder[i]);
    items[i].classList.remove("good","bad");
    items[i].classList.add(ok ? "good" : "bad");
    if(ok) correctPositions++;
  }

  const scoreAdd = correctPositions * 5;
  score += scoreAdd;
  setTop();

  // status
  statusEl.style.display = "block";
  if(correctPositions === correctOrder.length){
    statusEl.className = "status good";
    statusEl.textContent = `‚úÖ –£—Å–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ! +${scoreAdd} –±–∞–ª—ñ–≤`;
  }else if(correctPositions === 0){
    statusEl.className = "status bad";
    statusEl.textContent = `‚ùå –ñ–æ–¥–Ω–∞ –ø–æ–∑–∏—Ü—ñ—è –Ω–µ —Å–ø—ñ–≤–ø–∞–ª–∞. +0 –±–∞–ª—ñ–≤`;
  }else{
    statusEl.className = "status";
    statusEl.textContent = `‚ÑπÔ∏è –ü—Ä–∞–≤–∏–ª—å–Ω–∏—Ö –ø–æ–∑–∏—Ü—ñ–π: ${correctPositions} –∑ ${correctOrder.length}. +${scoreAdd} –±–∞–ª—ñ–≤`;
  }

  perLevel.push({
    level: levelIndex+1,
    size: correctOrder.length,
    correctPositions,
    scoreAdd,
    words: correctOrder.slice()
  });

  // –ø–µ—Ä–µ–π—Ç–∏ –¥–∞–ª—ñ –ø—ñ—Å–ª—è –ø–∞—É–∑–∏ (—â–æ–± –≤–∏–¥–Ω–æ –±—É–ª–æ –ø—ñ–¥—Å–≤—ñ—Ç–∫—É)
  setTimeout(()=>{
    levelIndex++;
    if(levelIndex < LEVEL_SIZES.length){
      startLevel();
    }else{
      finishGame();
    }
  }, 900);
}

btnCheck.addEventListener("click", checkLevel);

/* =======================
   END + TELEGRAM
   ======================= */
function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, m => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
  }[m]));
}

function buildSummary(){
  summaryEl.innerHTML = "";
  const totalMs = nowMs() - startTimeMs;
  const totalWords = perLevel.reduce((s,x)=>s+x.size,0);
  const totalCorrectPositions = perLevel.reduce((s,x)=>s+x.correctPositions,0);
  const accuracy = totalWords ? Math.round((totalCorrectPositions/totalWords)*100) : 0;

  const rows = [
    ["–Ü–º‚Äô—è", player.name],
    ["–ü–æ—à—Ç–∞", player.email],
    ["–ü—ñ–¥—Å—É–º–∫–æ–≤—ñ –±–∞–ª–∏", String(score)],
    ["–¢–æ—á–Ω—ñ—Å—Ç—å (–ø–æ–∑–∏—Ü—ñ—ó)", `${accuracy}% (${totalCorrectPositions}/${totalWords})`],
    ["–ß–∞—Å –ø—Ä–æ—Ö–æ–¥–∂–µ–Ω–Ω—è", formatTime(totalMs)]
  ];

  for(const [k,v] of rows){
    const div = document.createElement("div");
    div.className = "kv";
    div.innerHTML = `<span>${escapeHtml(k)}</span><b>${escapeHtml(v)}</b>`;
    summaryEl.appendChild(div);
  }

  const d = document.createElement("div");
  d.className = "divider";
  summaryEl.appendChild(d);

  for(const x of perLevel){
    const div = document.createElement("div");
    div.className = "kv";
    div.innerHTML = `<span>–†—ñ–≤–µ–Ω—å ${x.level} (—Å–ª—ñ–≤: ${x.size})</span><b>${x.correctPositions}/${x.size} ‚Ä¢ +${x.scoreAdd}</b>`;
    summaryEl.appendChild(div);
  }

  endSubEl.textContent = "–ì–æ—Ç–æ–≤–æ! –ù–∏–∂—á–µ ‚Äî –≤–∞—à –ø—ñ–¥—Å—É–º–æ–∫.";
}

function sendToTelegram(){
  const totalMs = nowMs() - startTimeMs;
  const totalWords = perLevel.reduce((s,x)=>s+x.size,0);
  const totalCorrectPositions = perLevel.reduce((s,x)=>s+x.correctPositions,0);
  const accuracy = totalWords ? Math.round((totalCorrectPositions/totalWords)*100) : 0;

  const details = perLevel.map(x => `–†${x.level}: ${x.correctPositions}/${x.size} (+${x.scoreAdd})`).join(" | ");

  const msg =
`üß† –ì—Ä–∞ "–ü–æ—Ä—è–¥–æ–∫ —Å–ª—ñ–≤" ‚Äî —Ä–µ–∑—É–ª—å—Ç–∞—Ç
üë§ –Ü–º‚Äô—è: ${player.name}
üìß –ü–æ—à—Ç–∞: ${player.email}
‚≠ê –ë–∞–ª–∏: ${score}
üéØ –¢–æ—á–Ω—ñ—Å—Ç—å: ${accuracy}% (${totalCorrectPositions}/${totalWords})
‚è± –ß–∞—Å: ${formatTime(totalMs)}
üìã ${details}`;

  const url = `https://api.telegram.org/bot${BOT_TOKEN}/sendMessage?chat_id=${encodeURIComponent(CHAT_ID)}&text=${encodeURIComponent(msg)}`;

  // –≤–∞–∂–ª–∏–≤–æ: –±–µ–∑ CORS, –≤—ñ–¥–ø–æ–≤—ñ–¥—å –Ω–µ —á–∏—Ç–∞—î–º–æ
  try{
    fetch(url, { method:"GET", mode:"no-cors" }).catch(()=>{});
  }catch(e){
    const img = new Image();
    img.src = url;
  }
}

function finishGame(){
  showScreen("end");
  buildSummary();
  sendToTelegram();
}

/* =======================
   START BUTTON FIX (MOBILE)
   ======================= */
let startGuard = false;

function startGame(e){
  // –∑–∞—Ö–∏—Å—Ç –≤—ñ–¥ –ø–æ–¥–≤—ñ–π–Ω–æ–≥–æ —Å–ø—Ä–∞—Ü—é–≤–∞–Ω–Ω—è touchstart+click
  if(startGuard) return;
  startGuard = true;
  setTimeout(()=> startGuard = false, 400);

  if(e && e.cancelable) e.preventDefault();

  const name = nameEl.value.trim();
  const email = emailEl.value.trim();

  if(!name){
    nameEl.focus();
    return;
  }
  if(!email || !/^\S+@\S+\.\S+$/.test(email)){
    emailEl.focus();
    return;
  }

  player.name = name;
  player.email = email;

  // reset
  clearInterval(countdownTimer);
  levelIndex = 0;
  score = 0;
  perLevel = [];
  startTimeMs = nowMs();
  setTop();

  showScreen("game");
  startLevel();
}

// –≤–∞–∂–ª–∏–≤–æ: —ñ click, —ñ touchstart (–∞–ª–µ –∑ guard)
btnStart.addEventListener("click", startGame, {passive:false});
btnStart.addEventListener("touchstart", startGame, {passive:false});

/* =======================
   RESTART
   ======================= */
btnRestart.addEventListener("click", ()=>{
  clearInterval(countdownTimer);
  score = 0;
  levelIndex = 0;
  perLevel = [];
  setTop();
  showScreen("start");
});

// init
setTop();
</script>
</body>
</html>
